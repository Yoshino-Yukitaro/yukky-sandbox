---
title: "ãƒ–ãƒ­ã‚°ã®og imageè‡ªå‹•ç”Ÿæˆã‚’å®Ÿè£…ã—ã¾ã—ãŸ"
createdAt: "2024-09-18"
description: "ã¤ã„ã«ã†ã¡ã®ãƒ–ãƒ­ã‚°ã«ã‚‚og imageè‡ªå‹•ç”Ÿæˆæ©Ÿèƒ½ãŒã€ã€ï¼ã“ã®è¨˜äº‹ã§ã¯ã©ã‚“ãªæ–¹æ³•ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã‹ãƒ»ã©ã“ã§ãƒãƒã£ãŸã‹ãªã©ã‚’ç´¹ä»‹ã—ã¾ã™"
link: https://yukky-sandbox.dev/post/2024-09-18-583
pubDate: "2024-09-18"
---

import { Picture } from "astro:assets";
import vercelPlaygroundPng from "../../images/post/2024-09-18-583/vercel_playground.png";
import ogpCheckerPng from "../../images/post/2024-09-18-583/ogp_checker.png";

ã‹ãªã‚Šä¹…ã—ã¶ã‚Šã®æ›´æ–°ã§ã™ã€‚ã€‚

ã¤ã„ã«ã€ã“ã®ãƒ–ãƒ­ã‚°ã«ã‚‚og imageè‡ªå‹•ç”ŸæˆãŒå®Ÿè£…ã•ã‚Œã¾ã—ãŸï¼ã‚„ã£ãŸãƒ¼ï¼ï¼ï¼ğŸ‰
ã“ã®è¨˜äº‹ã§ã¯

- ã©ã†ãªæ–¹æ³•ã§è‡ªå‹•ç”Ÿæˆã—ã¦ã„ã‚‹ã®ã‹
- ã©ã“ã§ãƒãƒã£ãŸã‹

ã‚’ç´¹ä»‹ã—ã¾ã™ï¼

## ã©ã‚“ãªæ–¹æ³•ã§è‡ªå‹•ç”Ÿæˆã—ã¦ã„ã‚‹ã®ã‹ï¼Ÿ

[vercel/satori](https://github.com/vercel/satori)ã¨[sharp](https://sharp.pixelplumbing.com/)ã‚’ç”¨ã„ãŸSSGã§ç”Ÿæˆã—ã¦ã„ã¾ã™ï¼(æœ¬å½“ã¯Cloudflare Workerã‚’ç”¨ã„ã¦SSRã§ç”Ÿæˆã—ãŸã‹ã£ãŸã‘ã©ã€ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã€‚ã€‚)
[vercel/satori](https://github.com/vercel/satori)ã¯Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰svgç”»åƒã‚’ç”Ÿæˆã§ãã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€[sharp](https://sharp.pixelplumbing.com/)ã¯ç”»åƒã®å¤‰æ›ãªã©ç”»åƒã«é–¢ã™ã‚‹ã„ã‚ã„ã‚ãªã“ã¨ãŒã§ãã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

### ç’°å¢ƒ

bun: v1.1.27
astro: v4.15.6
â†‘ã‚’CLoudflare pagesä¸Šã§hybrid modeã§é‹ç”¨ã—ã¦ã„ã¾ã™ã€‚

### å®Ÿéš›ã®æ‰‹é †

å®Ÿéš›ã®æ‰‹é †ã§ã¯ã“ã¡ã‚‰ã®ãƒ–ãƒ­ã‚°ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸï¼

<a href="https://blog.70-10.net/posts/satori-og-image/">
  https://blog.70-10.net/posts/satori-og-image/
</a>

ã–ã£ãã‚Šä¸‹è¨˜ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã™ï¼(ã‚³ãƒ¼ãƒ‰ã¯ä¸€éƒ¨ç°¡ç•¥åŒ–ã—ã¦ã„ã¾ã™)

1. Astroã®Reactã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

[Astroã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.astro.build/ja/guides/integrations-guide/react/)ã‚’å‚è€ƒã«Astroã®Reactã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™

```shell
bunx astro add react
```

ä½•ã‹èã‹ã‚ŒãŸã‚‰å…¨ã¦`yes`ã¨å›ç­”ã—ã¾ã™ã€‚

2. `satori`ã¨`sharp`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```shell
bun add satori sharp
```

```shell
bun add @types/sharp
```

3. og imageã«ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´

ä¸‹è¨˜ã®ã‚µã‚¤ãƒˆã‚’ä½¿ã£ã¦äº‹å‰ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ã—ã¾ã™ã€‚

<a href="https://og-playground.vercel.app/">
  https://og-playground.vercel.app/
</a>

<Picture
  src={vercelPlaygroundPng}
  formats={["avif", "webp"]}
  alt=""
  width={1911}
  height={954}
  decoding="async"
  loading="lazy"
/>

å®Ÿéš›ã«ç”Ÿæˆã•ã‚Œã‚‹ogpç”»åƒã¯å°‘ã—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒå´©ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€ã‚ãã¾ã§ã‚‚å‚è€ƒã«ã™ã‚‹ç¨‹åº¦ã§ã™ã€‚

4. og imageã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ã®ä½œæˆ

3ã§ä½œæˆã—ãŸHTMLã¯äº‹å‰ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã—ã¦ãŠãã¾ã™(ã“ã“ã§ã¯`_OgImage.tsx`ã«`OgImage`ã¨ã—ã¦ä½œæˆã—ã¦ã„ã¾ã™)ã€‚

(ä¸‹è¨˜ã¯`_getImage.tsx`ã¨ã—ã¦ä¿å­˜ã—ã¦ã„ã¾ã™)

```tsx
import satori from "satori";
import { OgImage } from "./_OgImage";
import sharp from "sharp";

export async function getOgImage(text: string): Promise<Buffer> {
  const notoSansJpUrl = `https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@600`;
  const reggeaeOneUlr =
    "https://fonts.googleapis.com/css2?family=Reggae+One&display=swap&text=ã‚†ã£ããƒ¼ã®ç ‚å ´";
  const notoSansJpFontData = await getFontData(notoSansJpUrl);
  const reggeaeOneFontData = await getFontData(reggeaeOneUlr);
  const svg = await satori(<OgImage text={text} />, {
    width: 800,
    height: 400,
    fonts: [
      {
        name: "Noto Sans JP",
        data: notoSansJpFontData,
        style: "normal",
      },
      {
        name: "Reggae One",
        data: reggeaeOneFontData,
        style: "normal",
      },
    ],
  });

  return await sharp(Buffer.from(svg)).png().toBuffer();
}

// ãƒ•ã‚©ãƒ³ãƒˆã®å–å¾—
const getFontData = async (url: string): Promise<ArrayBuffer> => {
  const css = await (
    await fetch(url, {
      headers: {
        "User-Agent":
          "Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_8; de-at) AppleWebKit/533.21.1 (KHTML, like Gecko) Version/5.0.5 Safari/533.21.1",
      },
    })
  ).text();

  const resource = css.match(
    /src: url\((.+)\) format\('(opentype|truetype)'\)/
  );

  if (resource === null) {
    throw new Error("Font resource not found");
  }

  return await fetch(resource[1]).then(async (res) => await res.arrayBuffer());
};
```

è‡ªåˆ†ã¯Google Fontã‚’ä½¿ã„ãŸã‹ã£ãŸã®ã§ã€ãã®ãƒ•ã‚©ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚‚å‹•çš„ã«å–å¾—ã—ã¦ã„ã¾ã™ã€‚

5. og imageã‚’é…ä¿¡ã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä½œæˆ

Astroã®SSGã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™(`[...slug].png.ts`)

```tsx
import type { APIContext } from "astro";
import { getCollection, getEntry } from "astro:content";
import { getOgImage } from "./_getOgImage";

export const getStaticPaths = async () => {
  const posts = await getCollection("post");
  return posts.map((post) => ({ params: { slug: post.slug } }));
};

export async function GET({ params, redirect }: APIContext) {
  const { slug } = params;
  if (slug === undefined) {
    return new Response(null, {
      status: 500,
      statusText: "No slug provided",
    });
  }
  const post = await getEntry("post", slug);
  if (post === undefined) {
    return new Response(null, {
      status: 404,
      statusText: "Not found",
    });
  }
  const body = await getOgImage(post?.data.title ?? "No title");
  return new Response(body);
}
```

Astroã§ã¯`getStaticPaths`ã‚’å®šç¾©ã™ã‚‹ã€ã¾ãŸã¯`export const prerender = true;`ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§é™çš„ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¾ãŸã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’`xxx.png.ts`ã®ã‚ˆã†ã«ã—ã¦ArrayBufferã‚’è¿”ã™ã“ã¨ã§ç”»åƒã‚’é…ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

é–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ã—ã¦ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’ç¢ºã‹ã‚ã¾ã—ã‚‡ã†ï¼

```shell
bun run dev
```

6. og imageã‚’ç¢ºã‹ã‚ã‚‹

ã“ã“ã¾ã§ã§ããŸã‚‰metaã‚¿ã‚°ã«`og:image`ã‚’è¿½åŠ ã—ã¦ã€å®Ÿéš›ã«ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèªã—ã¾ã™ï¼

```jsx
const ogImageUrl =
  ogEnv === "production"
    ? `https://yukky-sandbox.dev/og/${slug}.png`
    : ogEnv === "preview"
      ? `https://develop.yukky-sandbox.pages.dev/og/${slug}.png`
      : `http://localhost:4321/og/${slug}.png`;
```

```jsx
<meta property="og:image" content={ogImageUrl} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
```

ç¢ºã‹ã‚ã‚‹éš›ã¯cloudflare pagesã®devç’°å¢ƒã®URLã‚’ä¸‹è¨˜ã®ã‚µã‚¤ãƒˆã«å…¥ã‚Œã¦ç¢ºèªã—ã¾ã™

<a href="https://web-toolbox.dev/tools/ogp-checker">
  https://web-toolbox.dev/tools/ogp-checker
</a>

å¤§ä½“æƒ³å®šã¨é•ã†ã‚‚ã®ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ãã®å ´åˆã¯éƒ½åº¦èª¿æ•´ã—ã¦ãã ã•ã„ï¼

<Picture
  src={ogpCheckerPng}
  formats={["avif", "webp"]}
  alt=""
  width={1473}
  height={626}
  decoding="async"
  loading="lazy"
/>

## ã©ã“ã§ãƒãƒã£ãŸã‹

åŸå› ã®èª¿æŸ»ãŒä»•åˆ‡ã‚Œã¦ãªã„ã‚‚ã®ã‚‚ã‚ã‚‹ã®ã§ç®‡æ¡æ›¸ãã§æ›¸ã„ã¦ã„ãã¾ã™

- SSRã‚’è©¦ã—ã¦ã„ã‚‹æ™‚ã€sharpãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œãšã«ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ‰±ã„ã•ã‚Œã¦ã—ã¾ã†
- bun run devã§ã¯å‹•ä½œã™ã‚‹ãŒã€bun buildå¾Œã¯å‹•ä½œã—ãªã„
- ä»£æ›¿ã§ä½¿ãŠã†ã¨ã—ãŸresvg-jsãŒ`nodejs compatibility`ã®å½±éŸ¿ã§å‹•ä½œã—ãªã„
- cloudflareã®workerdãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚‚bunã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚‚nodejs compatibilityãŒ100%ã§ã¯ãªãã€ä½¿ãˆãªã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãªã©ãŒå­˜åœ¨ã™ã‚‹
  - ä»£ã‚ã‚Šã«ä½¿ç”¨ã—ã‚ˆã†ã¨ã—ãŸCloudflare Pages FunctionsãŒCloudflareã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®å¯¾è±¡å¤–ã«ãªã£ã¦ã„ãŸ -[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.astro.build/ja/guides/deploy/cloudflare/#pages-functions%E3%81%AE%E4%BD%BF%E7%94%A8)ä¸Šã§ã¯ã§ããã†ãªæã‹ã‚Œæ–¹ã«ãªã£ã¦ã„ã‚‹ãŒã€å®Ÿéš›ã¯ã§ããªã„

<blockquote class="twitter-tweet">
  <p lang="ja" dir="ltr">
    ã©ã†ã‚‚å°‘ã—å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Cloudflare Adapterã‹ã‚‰ã€Cloudflare Pages
    Functionã®ã‚µãƒãƒ¼ãƒˆãŒæ¶ˆæ»…ã—ã¦ã„ãŸã‚‰ã—ã„ğŸ« 
    <br />
    ä»£ã‚ã‚Šã«Astro Endpointã‚’ä½¿ãˆã¨ã®ã“ã¨ã€‚
    <a href="https://t.co/wNAVImZEPC">https://t.co/wNAVImZEPC</a>
    <br />
    ã“ã‚Œã§å¤±æ•—ã—ãŸã‹ã‚‰Pages Functionã‚’ä½¿ã£ã¦ã¿ãŸã®ã«ãªğŸ˜­
    <a href="https://t.co/4JVkHlflJq">https://t.co/4JVkHlflJq</a>
  </p>
  &mdash; ã‚†ã£ããƒ¼ (@Yu_yukk_Y)
  <a href="https://twitter.com/Yu_yukk_Y/status/1835832875385852150?ref_src=twsrc%5Etfw">
    September 17, 2024
  </a>
</blockquote> <script
  async
  src="https://platform.twitter.com/widgets.js"
  charset="utf-8"
></script>

- â†‘ãŒå¯¾è±¡å¤–ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€ãƒ­ã‚°ä¸Šã¯å‹•ã„ã¦ã„ã‚‹ã“ã¨ã«ãªã£ã¦ã„ãŸãŸã‚èª¿æŸ»ãŒé›£èˆªã—ãŸ
